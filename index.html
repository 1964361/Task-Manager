<!DOCTYPE html>
<html>
<head>
    <title>Advanced Chat Site</title>
    <style>
        body {
            font-family: Arial, sans-serif;
        }

        #chat-container {
            width: 500px;
            margin: auto;
        }

        #chat-window {
            height: 400px;
            border: 1px solid #999;
            padding: 10px;
            overflow-y: scroll;
        }

        .message {
            margin-bottom: 10px;
        }

        .message span {
            color: #888;
            font-size: 0.8em;
        }

        #chat-input {
            width: 100%;
            line-height: 2em;
            border: 1px solid #999;
            border-radius: 5px;
            padding: 5px;
        }
    </style>
</head>
<body>
    <div id="chat-container">
        <input type="text" id="username-input" placeholder="Enter your username..." />
        <div id="chat-window"></div>
        <input type="text" id="chat-input" placeholder="Type your message here..." disabled />
    </div>
    <script src="https://cdn.pubnub.com/sdk/javascript/pubnub.4.21.7.js"></script>
    <script>
        const pubnub = new PubNub({
            subscribeKey: 'sub-c-15509578-7ad1-4d3e-b793-2201fcb2a8f8',
            publishKey: 'pub-c-c92f97a6-ffe6-41cf-98cd-012e1e1de1a6',
            uuid: 'sec-c-YjJhNjJiNjAtYmIxOS00NDMzLTkyMmItNTMxOWI4NzJiNWIw'
        });

        const usernameInput = document.querySelector('#username-input');
        const chatInput = document.querySelector('#chat-input');
        const chatWindow = document.querySelector('#chat-window');

        usernameInput.addEventListener('keydown', (event) => {
            if (event.keyCode === 13 && usernameInput.value) {
                pubnub.setUUID(usernameInput.value);
                usernameInput.disabled = true;
                chatInput.disabled = false;
                chatInput.focus();

                pubnub.history({
                    channel: 'chat',
                    count: 100, // how many items to fetch
                }, function (status, response) {
                    response.messages.forEach((msg) => {
                        displayMessage(msg.entry);
                    });
                });
            }
        });

        chatInput.addEventListener('keydown', (event) => {
            if (event.keyCode === 13 && chatInput.value) {
                const message = { username: pubnub.getUUID(), text: chatInput.value };
                pubnub.publish({
                    channel: 'chat',
                    message: message
                });

                chatInput.value = '';
            }
        });

        function displayMessage(message) {
            const messageElement = document.createElement('div');
            messageElement.classList.add('message');
            messageElement.innerHTML = `<strong>${message.username}</strong>: ${message.text} <span>${new Date().toLocaleTimeString()}</span>`;
            chatWindow.appendChild(messageElement);

            // Scroll to the bottom of the chat window
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }

        pubnub.addListener({
            message: function(msg) {
                displayMessage(msg.message);
            }
        });

        pubnub.subscribe({
            channels: ['chat']
        });
    </script>
</body>
</html>
